# Рекомендуемая инфраструктура для MOznoDS

Этот документ описывает минимальные и рекомендуемые системные требования для развертывания платформы MOznoDS, включая основное приложение (Django + Channels) и вспомогательный сервер WebRTC (Coturn).

---

## 1. Основное приложение (Django, Channels, SQLite)

MOznoDS спроектирован как легковесное решение, использующее SQLite и Django Channels (в режиме `InMemoryChannelLayer` для экономии ресурсов).

### Минимальные требования (до 10-20 онлайн-пользователей):
- **CPU**: 1 ядро (Shared vCPU).
- **RAM**: 1 ГБ (минимум 512 МБ, но 1 ГБ обеспечит стабильность при сборке фронтенда и работе нескольких процессов Daphne).
- **Диск**: 10 ГБ HDD/SSD (SQLite база данных и медиа-файлы занимают мало места в начале).
- **ОС**: Ubuntu 22.04 LTS или аналогичный Linux.

### Рекомендуемые требования (50+ пользователей):
- **CPU**: 2 ядра (Dedicated).
- **RAM**: 2-4 ГБ.
- **Диск**: 20 ГБ NVMe.
- **Рекомендация**: При росте нагрузки стоит перейти с `InMemoryChannelLayer` на **Redis** и использовать **PostgreSQL** вместо SQLite.

---

## 2. WebRTC (STUN/TURN)

Для работы звонков используются два типа серверов:

1. **STUN (Session Traversal Utilities for NAT)**: Помогает устройствам узнать свой внешний IP. Работает быстро, трафик через него не идет.
   - **Для РФ**: В приложении уже настроены серверы Яндекса, Mail.ru и др. Это обеспечивает минимальную задержку при установке соединения.
2. **TURN (Traversal Using Relays around NAT)**: Пересылает весь трафик через себя. **Необходим**, если устройства находятся за строгим NAT (мобильный интернет, офисные сети).

### Coturn (ваш собственный TURN сервер)
Хотя STUN серверы Яндекса помогают соединиться, они **не заменяют** TURN. Если у пользователя 4G/LTE, без вашего Coturn звонок может не начаться.

### Минимальные требования:
- **CPU**: 1 ядро.
- **RAM**: 512 МБ.
- **Канал**: 100 Мбит/с (безлимитный трафик).
- **Порты**: 3478 (TCP/UDP), 5349 (TLS), и диапазон 49152-65535 (UDP).

### Рекомендуемые требования:
- **CPU**: 1-2 ядра (в зависимости от количества одновременных видео-звонков).
- **RAM**: 1 ГБ.
- **Канал**: 1 Гбит/с.
- **Трафик**: WebRTC видео-звонки потребляют значительный объем трафика (~1-2 Мбит/с на участника). Убедитесь, что ваш хостинг-провайдер предоставляет достаточный лимит.

---

## 3. Советы по развертыванию (Self-hosted)

1. **Docker**: Рекомендуется использовать Docker Compose для изоляции компонентов.
2. **Reverse Proxy**: Используйте **Nginx** или **Caddy** для обработки HTTPS/WSS и отдачи статики.
3. **Безопасность**:
   - Используйте `UFW` или `iptables` для ограничения доступа.
   - Настройте `fail2ban` для защиты от перебора паролей.
   - Для TURN используйте `lt-cred-mech` (Long-term credential mechanism).

---

## 4. Динамические домены (localhost.run / Cloudflare Tunnel)

Если вы используете временные домены (например, `localhost.run`), обязательно настройте фронтенд на использование переменных окружения (`.env.production`), чтобы не менять URL вручную при каждом перезапуске.

```bash
# Пример .env.production
VITE_API_URL=https://your-dynamic-id.lhr.life
VITE_WS_URL=wss://your-dynamic-id.lhr.life
```
